<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

  <head>
    <title>Barcodes</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            plugins: [
                "@tailwindcss/forms"
            ],
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                    }
                }
            }
        }
    </script>
  </head>

  <body class="px-12 py-12">
    <div class="relative overflow-x-auto">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
        <tr>
          <th scope="col" class="px-6 py-3">Barcode</th>
          <th scope="col" class="px-6 py-3">Description</th>
        </tr>
      </thead>
      <tbody>
        <tr  th:each="barcode : ${barcodes}" class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
          <td scope="row" class="px-6 py-4" th:text="${{barcode.barcode}}">barcode</td>
          <td scope="row" class="px-6 py-4">
            
                <ul class="max-w-md text-gray-900" 
                    th:each="row,rowStat : ${barcode.descriptions}">
                  <li class="mb-1 text-gray-500 md:text-lg dark:text-gray-400 " ><strong th:text="${row.locale.language}" class="font-semibold"></strong> <span th:text="${row.text}" ></span></li>                  
          </ul>
              
          </td>
        </tr>
      </tbody>
    </table>
  </div>
    
    
    <form class="space-x-12 space-y-12">
        <div class="border-b border-gray-900/10 pb-12">
            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                <div class="sm:col-span-4">
                    <label for="locale" class="block text-sm font-medium leading-6 text-gray-900">Country</label>
                    <div class="mt-2">
                        <select id="locale" name="locale" autocomplete="country-name"
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:max-w-xs sm:text-sm sm:leading-6">
                            <option value="nl-BE" selected>NL (Belgium)</option>
                            <option value="fr-BE">FR (Belgium)</option>

                        </select>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="barcode" class="block text-sm font-medium leading-6 text-gray-900">Barcode</label>
                    <div class="mt-2">
                        <div
                            class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            <input type="text" name="barcode" id="barcode" autocomplete="username"
                                class="block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6"
                                placeholder="" required autofocus>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">

                <div class="col-span-full">

                    <label for="description"
                        class="block text-sm font-medium leading-6 text-gray-900">Description</label>
                    <div class="mt-2">
                        <textarea id="description" name="description" rows="3" required
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
                    </div>
                    <p class="mt-3 text-sm leading-6 text-gray-600">Description.</p>
                </div>
            </div>
            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">

            </div>
        </div>
        <div class="mt-6 flex items-center justify-end gap-x-6">
            <button id="submit" type="submit"
                class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Save</button>
        </div>
    </form>

    <script>

        const submitButton = document.getElementById('submit');
        submitButton.addEventListener("click", (e) => {
            e.preventDefault();
            const form = document.getElementsByTagName('form')[0];
            console.log(`form valid? ${form.checkValidity()}`);
            if (form.checkValidity()) {

                const requestBody = {
                    "barcode": document.getElementById('barcode').value,
                    "descriptions": [
                        {
                            "locale": document.getElementById('locale').value,
                            "text": document.getElementById('description').value
                        }
                    ]
                };
                console.log(requestBody);
                (async () => {
                    try {
                        const response = await fetch("http://localhost:8080/api/v1/barcode", {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(requestBody)
                        });
                        const json = await response.json();
                        form.reset();
                        document.getElementById('barcode').focus()
                    }
                    catch (error) {
                        console.log(error);
                    }
                })();
            }
            else {
                form.reportValidity();
            }
        });
        const barcode = document.getElementById('barcode');
        barcode.addEventListener("focusout", () => {
            (async () => {
                    try {
                        const response = await fetch(`http://localhost:8080/api/v1/barcode/${barcode.value}`);
                        const json = await response.json();
                        if(json.length>0){
                            console.log('element already in DB');
                        }
                    }
                    catch (error) {
                        console.log(error);
                    }
                })();
        });
    </script>
</body>
</html>